---
title: "Figure 1A: Arabidopsis GO CC & MF Enrichment Analysis"
author: "Yaqian Huang, Zongmin Li, Hongfang Jin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Data input/output
library(readxl)
library(openxlsx)

# Enrichment analysis
library(clusterProfiler)
library(org.At.tair.db)
# Read input file from data/ folder
gene_data <- read_excel("data/Arabidopsis_protein.xlsx")

# Extract TAIR locus IDs (column name must be "TAIR")
genes <- gene_data$TAIR

# Remove NA and duplicates
genes <- unique(genes[!is.na(genes)])

# Print input summary
cat("Number of input genes:", length(genes), "\n")
# Cellular Component (CC)
ego_CC <- enrichGO(gene          = genes,
                   OrgDb         = org.At.tair.db,
                   keyType       = "TAIR",
                   ont           = "CC",
                   pAdjustMethod = "BH",
                   pvalueCutoff  = 0.05,
                   qvalueCutoff  = 0.2,
                   minGSSize     = 10,
                   maxGSSize     = 2000,
                   readable      = TRUE)

if (is.null(ego_CC) || nrow(as.data.frame(ego_CC)) == 0) {
    stop("❌ No significant GO CC terms found. Please check TAIR IDs.")
}

# Simplify CC results
ego_CC_simpl <- simplify(ego_CC,
                         cutoff     = 0.7,
                         by         = "p.adjust",
                         select_fun = min,
                         measure    = "Wang")

# Molecular Function (MF)
ego_MF <- enrichGO(gene          = genes,
                   OrgDb         = org.At.tair.db,
                   keyType       = "TAIR",
                   ont           = "MF",
                   pAdjustMethod = "BH",
                   pvalueCutoff  = 0.05,
                   qvalueCutoff  = 0.2,
                   minGSSize     = 10,
                   maxGSSize     = 2000,
                   readable      = TRUE)

if (is.null(ego_MF) || nrow(as.data.frame(ego_MF)) == 0) {
    stop("❌ No significant GO MF terms found. Please check TAIR IDs.")
}

# Simplify MF results
ego_MF_simpl <- simplify(ego_MF,
                         cutoff     = 0.7,
                         by         = "p.adjust",
                         select_fun = min,
                         measure    = "Wang")
# Export enrichment results (CC and MF in separate sheets)
write.xlsx(list(CC = as.data.frame(ego_CC_simpl),
                MF = as.data.frame(ego_MF_simpl)),
           "results/arabidopsis_GO_CC_MF_result.xlsx")

# Export plots as PDF
pdf("results/Arabidopsis_GO_CC_barplot.pdf", width = 12, height = 10)
barplot(ego_CC_simpl, showCategory = 30, title = "Top 30 GO CC Terms (Arabidopsis)")
dev.off()

pdf("results/Arabidopsis_GO_CC_dotplot.pdf", width = 12, height = 10)
dotplot(ego_CC_simpl, showCategory = 30, title = "Top 30 GO CC Terms (Arabidopsis)")
dev.off()

pdf("results/Arabidopsis_GO_MF_barplot.pdf", width = 12, height = 10)
barplot(ego_MF_simpl, showCategory = 30, title = "Top 30 GO MF Terms (Arabidopsis)")
dev.off()

pdf("results/Arabidopsis_GO_MF_dotplot.pdf", width = 12, height = 10)
dotplot(ego_MF_simpl, showCategory = 30, title = "Top 30 GO MF Terms (Arabidopsis)")
dev.off()
