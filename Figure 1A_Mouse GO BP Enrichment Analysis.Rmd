---
title: "Figure 1A: Mouse GO BP Enrichment Analysis"
author: "Yaqian Huang, Zongmin Li, Hongfang Jin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Data input/output
library(readxl)
library(openxlsx)

# Enrichment analysis
library(clusterProfiler)
library(org.Mm.eg.db)
library(AnnotationDbi)
# Read input file from data/ folder
gene_data <- read_excel("data/Mouse_protein.xlsx")

# Extract Uniprot ID vector
genes <- gene_data$uniprot_id
gene_entrez <- AnnotationDbi::select(org.Mm.eg.db,
                                     keys = genes,
                                     keytype = "UNIPROT",
                                     columns = c("ENTREZID"))

# Remove NA and duplicates
gene_entrez <- gene_entrez[!is.na(gene_entrez$ENTREZID), ]
entrez_ids <- unique(gene_entrez$ENTREZID)

# Print mapping summary
cat("Number of input genes:", length(genes), "\n")
cat("Number of mapped ENTREZIDs:", length(entrez_ids), "\n")
ego <- enrichGO(gene          = entrez_ids,
                OrgDb         = org.Mm.eg.db,
                keyType       = "ENTREZID",
                ont           = "BP",
                pAdjustMethod = "BH",
                pvalueCutoff  = 0.05,
                qvalueCutoff  = 0.2,
                minGSSize     = 10,
                maxGSSize     = 2000,
                readable      = TRUE)
ego_simpl <- simplify(ego,
                      cutoff     = 0.7,        # Similarity threshold
                      by         = "p.adjust", # Keep terms with smaller adjusted p-value
                      select_fun = min,
                      measure    = "Wang")
# Export results table
write.xlsx(as.data.frame(ego_simpl), "results/mouse_GO_result.xlsx")

# Export barplot
pdf("results/Mouse_GO_BP_barplot.pdf", width = 12, height = 10)
barplot(ego_simpl, showCategory = 30, title = "Top 30 GO BP Terms (Mouse)")
dev.off()

# Export dotplot
pdf("results/Mouse_GO_BP_dotplot.pdf", width = 12, height = 10)
dotplot(ego_simpl, showCategory = 30, title = "Top 30 GO BP Terms (Mouse)")
dev.off()
