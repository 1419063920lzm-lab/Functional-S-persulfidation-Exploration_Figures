---
title: "Chord Diagram"
author: "Yaqian Huang, Zongmin Li, Hongfang Jin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
# Load required packages
library(readxl)
library(tidyverse)
library(circlize)
library(RColorBrewer)

# Create results folder if it does not exist
if (!dir.exists("results")) dir.create("results")
# Read Excel file (replace with your actual filename under data/)
data <- read_excel("data/your_file.xlsx")

# Rename the first column as AC_site (protein modification site)
colnames(data)[1] <- "AC_site"
# Convert data into long format: each row = one protein site in one organ
long_data <- data %>%
  pivot_longer(
    cols = -AC_site,
    names_to = "Organ",
    values_to = "OxValue"
  )
# For each protein site, compute pairwise organ differences
organ_pairs <- long_data %>%
  group_by(AC_site) %>%
  summarise(
    pairwise = list(
      purrr::map_dfr(
        combn(Organ, 2, simplify = FALSE),
        function(pair) {
          val1 <- OxValue[Organ == pair[1]]
          val2 <- OxValue[Organ == pair[2]]
          tibble(
            from = pair[1],
            to = pair[2],
            weight = ifelse(is.na(val1) | is.na(val2), NA, abs(val1 - val2))
          )
        }
      )
    ),
    .groups = "drop"
  ) %>%
  unnest(pairwise) %>%
  filter(!is.na(from) & !is.na(to))
# Compute average difference between each organ pair
avg_diff <- organ_pairs %>%
  group_by(from, to) %>%
  summarise(
    avg_weight = mean(weight, na.rm = TRUE),
    .groups = "drop"
  )
# Save chord diagram to PDF
pdf("results/organ_chord_diagram.pdf", width = 8, height = 8)

chordDiagram(
  x = avg_diff,
  grid.col = RColorBrewer::brewer.pal(7, "Set3"),
  transparency = 0.2,
  directional = 1,
  annotationTrack = "grid",
  preAllocateTracks = list(track.height = 0.05)
)

circos.clear()
dev.off()
