---
title: "Figure 1A: Mouse GO CC and MF Enrichment Analysis"
author: "Yaqian Huang, Zongmin Li, Hongfang Jin"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Data input/output
library(readxl)
library(openxlsx)

# Enrichment analysis
library(clusterProfiler)
library(org.Mm.eg.db)
library(AnnotationDbi)
# Read input file from data/ folder
gene_data <- read_excel("data/Mouse_protein.xlsx")

# Extract Uniprot ID vector
genes <- gene_data$uniprot_id
gene_entrez <- AnnotationDbi::select(org.Mm.eg.db,
                                     keys = genes,
                                     keytype = "UNIPROT",
                                     columns = c("ENTREZID"))

# Remove NA and duplicates
gene_entrez <- gene_entrez[!is.na(gene_entrez$ENTREZID), ]
entrez_ids <- unique(gene_entrez$ENTREZID)

# Print mapping summary
cat("Number of input genes:", length(genes), "\n")
cat("Number of mapped ENTREZIDs:", length(entrez_ids), "\n")
# Cellular Component (CC)
ego_CC <- enrichGO(gene          = entrez_ids,
                   OrgDb         = org.Mm.eg.db,
                   keyType       = "ENTREZID",
                   ont           = "CC",
                   pAdjustMethod = "BH",
                   pvalueCutoff  = 0.05,
                   qvalueCutoff  = 0.2,
                   minGSSize     = 10,
                   maxGSSize     = 2000,
                   readable      = TRUE)

ego_CC_simpl <- simplify(ego_CC,
                         cutoff     = 0.7,
                         by         = "p.adjust",
                         select_fun = min,
                         measure    = "Wang")

# Molecular Function (MF)
ego_MF <- enrichGO(gene          = entrez_ids,
                   OrgDb         = org.Mm.eg.db,
                   keyType       = "ENTREZID",
                   ont           = "MF",
                   pAdjustMethod = "BH",
                   pvalueCutoff  = 0.05,
                   qvalueCutoff  = 0.2,
                   minGSSize     = 10,
                   maxGSSize     = 2000,
                   readable      = TRUE)

ego_MF_simpl <- simplify(ego_MF,
                         cutoff     = 0.7,
                         by         = "p.adjust",
                         select_fun = min,
                         measure    = "Wang")
# Export results to Excel with two sheets (CC and MF)
write.xlsx(list(CC = as.data.frame(ego_CC_simpl),
                MF = as.data.frame(ego_MF_simpl)),
           "results/mouse_GO_CC_MF_result.xlsx")

# Export plots to PDF
pdf("results/Mouse_GO_CC_barplot.pdf", width = 12, height = 10)
barplot(ego_CC_simpl, showCategory = 30, title = "Top 30 GO CC Terms (Mouse)")
dev.off()

pdf("results/Mouse_GO_CC_dotplot.pdf", width = 12, height = 10)
dotplot(ego_CC_simpl, showCategory = 30, title = "Top 30 GO CC Terms (Mouse)")
dev.off()

pdf("results/Mouse_GO_MF_barplot.pdf", width = 12, height = 10)
barplot(ego_MF_simpl, showCategory = 30, title = "Top 30 GO MF Terms (Mouse)")
dev.off()

pdf("results/Mouse_GO_MF_dotplot.pdf", width = 12, height = 10)
dotplot(ego_MF_simpl, showCategory = 30, title = "Top 30 GO MF Terms (Mouse)")
dev.off()
